name: Sync Upstream and Push to Gitea

on:
  schedule:
    - cron: '0 0 */5 * *' # 每天 UTC 00:00（北京时间 08:00）执行
  workflow_dispatch: # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # 增加超时时间，避免大仓库同步中断

    steps:
      # 步骤 1：检出 Fork 仓库（完整历史 + 保留本地 .github）
      - name: Checkout Forked Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0 # 必须获取完整 git 历史
          persist-credentials: false # 避免凭证冲突

      # 步骤 2：配置 Git 基础环境
      - name: Configure Git Identity & Network
        run: |
          # 设置提交身份
          git config --global user.name "GitHub Actions Bot"
          # 优化网络配置（针对大文件/慢网络）
          git config http.postBuffer 524288000
          git config http.lowSpeedLimit 1000
          git config http.lowSpeedTime 300
          git config core.compression 0  # 禁用压缩，加快传输

      # 步骤 3：添加上游仓库远程地址并拉取最新代码
      - name: Add Upstream Remote & Fetch
        run: |
          git remote add upstream https://github.com/vbenjs/vue-vben-admin.git
          git remote -v  # 验证远程仓库添加结果
          git fetch upstream main  # 拉取上游最新代码（仅拉取，不合并）

      # 步骤 4：合并上游代码（核心：跳过 .github 目录 + 完善容错）
      - name: Merge Upstream (Exclude .github Directory)
        run: |
          # 标记合并开始
          echo "=== Starting merge from upstream/main ==="

          # 先检查是否有更新可合并
          if git diff --quiet main upstream/main; then
            echo "ℹ️ Local branch is already up to date with upstream/main, skip merge"
            exit 0  # 无更新，退出当前步骤（后续步骤仍执行）
          fi

          # 尝试无提交合并（--no-commit 保留手动控制）
          MERGE_SUCCESS=0
          if git merge upstream/main --no-commit --no-edit; then
            MERGE_SUCCESS=1
          else
            # 常规合并失败，尝试允许不相关历史
            echo "Normal merge failed, retry with --allow-unrelated-histories"
            if git merge upstream/main --no-commit --no-edit --allow-unrelated-histories; then
              MERGE_SUCCESS=1
            else
              echo "❌ Merge failed even with --allow-unrelated-histories"
              git merge --abort 2>/dev/null || true  # 容错：无合并时不报错
              exit 1
            fi
          fi

          # 排除 .github 目录（核心逻辑）
          if [ $MERGE_SUCCESS -eq 1 ]; then
            echo "=== Excluding .github directory from merge ==="
            # 取消暂存 .github 目录的变更
            git reset HEAD .github/ 2>/dev/null || true
            # 强制保留本地 .github 目录
            git checkout HEAD -- .github/ 2>/dev/null || true
            # 清理临时文件
            git clean -fd .github/ 2>/dev/null || true

            # 提交合并结果（避免空提交）
            echo "=== Committing merge result ==="
            if git status --porcelain | grep -v "^??" | grep -qv ".github/"; then
              git commit -m "Merge upstream/main (exclude .github directory) - $(date +%Y-%m-%d)"
              echo "✅ Merge completed successfully"
            else
              git merge --abort 2>/dev/null || true
              echo "ℹ️ No changes to merge (skip commit)"
            fi
          fi

      # 步骤 5：推送更新到 GitHub Fork 仓库
      - name: Push to GitHub Fork
        run: |
          # 重新设置 origin 远程（避免凭证问题）
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          # 仅当有变更时推送
          if ! git diff --quiet main origin/main; then
            git push origin main --force-with-lease  # 安全强制推送
            echo "✅ Pushed to GitHub Fork successfully"
          else
            echo "ℹ️ No changes to push to GitHub Fork"
          fi

      # 步骤 6：推送更新到 Gitea（修复 stale info 报错）
      - name: Push to Gitea Private Repository
        run: |
          # 添加 Gitea 远程仓库
          GITEA_REPO_URL="https://oauth2:${{ secrets.GITEA_TOKEN }}@gitea.aipper.de/aipper/webbase.git"
          git remote add gitea "${GITEA_REPO_URL}"

          # 关键修复：刷新 Gitea 远程缓存（解决 stale info）
          git fetch gitea main 2>/dev/null || true

          # 仅当有变更时推送
          if ! git diff --quiet main gitea/main; then
            # 优先用安全的 force-with-lease
            git push gitea main --force-with-lease=main:main || {
              # 兜底用强制推送（仅限个人维护的仓库）
              echo "⚠️ force-with-lease failed, fallback to force push"
              git push gitea main --force
            }
            echo "✅ Pushed to Gitea successfully"
          else
            echo "ℹ️ No changes to push to Gitea"
          fi

          # 清理远程配置（避免冲突）
          git remote remove gitea

      # 步骤 7：输出同步结果（便于调试）
      - name: Print Sync Summary
        run: |
          echo "=== Sync Summary ==="
          git log --oneline -5  # 打印最新 5 条提交
          git remote -v         # 验证远程配置
          echo "✅ Sync workflow completed at $(date +%Y-%m-%d\ %H:%M:%S)"       git config --global user.email "github-actions[bot]@users.noreply.github.com"
